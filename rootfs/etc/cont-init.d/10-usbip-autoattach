#!/usr/bin/env bash
# cont-init hook for HA add-on (s6-overlay cont-init)
set -euo pipefail

# read values from add-on config (Supervisor injects config as /data/options.json)
if [ -f /data/options.json ]; then
  SERVER="$(jq -r '.discovery_server_address // empty' /data/options.json)"
  BUSID="$(jq -r '.devices[0].bus_id // empty' /data/options.json)"
  export SERVER BUSID
fi

# ensure script is executable
chmod +x /etc/cont-init.d/usbip-auto-attach.sh

# If s6 service dir exists in image, rely on s6 supervision (service will exec this script)
if [ -d /etc/s6/services/usbip-auto-attach ]; then
  # nothing more to do; s6 will start the supervised service
  true
else
  # fallback: start watcher in background so logs appear in container output
  /etc/cont-init.d/usbip-auto-attach.sh &>/proc/1/fd/1 &
fi
